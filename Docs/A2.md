# A2:2021 - Cryptographic Failures (Fallos CriptogrÃ¡ficos)

## ğŸ¯ Â¿QuÃ© probar?

Verificar el manejo de datos sensibles, uso de HTTPS, y exposiciÃ³n de informaciÃ³n confidencial.

---

## âœ… Prueba 1: Verificar uso de HTTPS vs HTTP

### ğŸ“¡ Inspeccionar headers del servidor

```bash
curl -I http://localhost:5247
```

**Respuesta esperada:**

```
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Date: Tue, 26 Nov 2025 10:30:00 GMT
Server: Kestrel
```

**AnÃ¡lisis:**

- âš ï¸ **En desarrollo**: Usar HTTP es normal (localhost)
- ğŸ”´ **En producciÃ³n**: DEBE usar HTTPS (datos cifrados en trÃ¡nsito)
- ğŸ”´ **Impacto sin HTTPS**: ContraseÃ±as, cookies, tokens interceptables (Man-in-the-Middle)

---

### ğŸ“¡ Verificar headers de seguridad

```bash
curl -I http://localhost:5247 | grep -i "strict-transport\|x-frame\|x-content\|x-xss"
```

**Headers de seguridad recomendados:**

```
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'self'
```

**AnÃ¡lisis:**

- âŒ Si NO tiene estos headers â†’ **Vulnerable a clickjacking, MIME sniffing, etc.**
- âœ… Si los tiene â†’ **Mejor postura de seguridad**

---

## âœ… Prueba 2: ExposiciÃ³n de datos sensibles en respuestas

### ğŸ“¡ Buscar contraseÃ±as o tokens en HTML

```bash
# Buscar palabras clave sensibles en la pÃ¡gina principal
curl -s http://localhost:5247 | grep -iE "password|apikey|secret|token|connectionstring"

# Buscar en JavaScript incluido
curl -s http://localhost:5247 | grep -oP '<script.*?</script>' | grep -iE "password|key|secret"
```

**Â¿QuÃ© buscar?**

- âŒ ContraseÃ±as hardcodeadas en JS: `var password = "admin123";`
- âŒ API keys expuestas: `const apiKey = "sk_live_abc123";`
- âŒ Tokens en comentarios: `<!-- Token: eyJhbGc... -->`
- âœ… Si no encuentra nada â†’ **Correcto**

---

### ğŸ“¡ Inspeccionar respuestas JSON (si la app tiene API)

```bash
# Si hubiera endpoints API REST
curl -s http://localhost:5247/api/peliculas | jq '.'
```

**Buscar:**

- âŒ Campos sensibles: `"password": "..."`, `"creditCard": "..."`
- âŒ InformaciÃ³n del sistema: `"dbConnectionString": "..."`
- âœ… Solo datos necesarios (tÃ­tulo, descripciÃ³n, etc.)

---

## âœ… Prueba 3: ExposiciÃ³n de informaciÃ³n en errores

### ğŸ“¡ Provocar un error y analizar la respuesta

```bash
# Error 404 con ID inexistente
curl -i http://localhost:5247/Peliculas/Details/99999
```

**Respuesta vulnerable:**

```
HTTP/1.1 404 Not Found

System.NullReferenceException: Object reference not set to an instance of an object.
   at peliculasweb.Controllers.PeliculasController.Details(Int32 id) in C:\Projects\peliculasweb\Controllers\PeliculasController.cs:line 45
   at lambda_method(Closure , Object , Object[] )
   ...
ConnectionString: Server=db;Database=peliculasweb;User=sa;Password=YourStrong@Passw0rd;
```

**AnÃ¡lisis:**

- âŒ **VULNERABLE**: Expone stack trace, rutas del servidor, y CONNECTION STRING con contraseÃ±a
- ğŸ”´ **Impacto**: InformaciÃ³n Ãºtil para atacantes (estructura del cÃ³digo, tecnologÃ­as, credenciales)

**Respuesta segura:**

```
HTTP/1.1 404 Not Found
Content-Type: text/html

<h1>404 - Not Found</h1>
<p>The resource you requested does not exist.</p>
```

---

### ğŸ“¡ Error de validaciÃ³n con datos malformados

```bash
# Enviar datos invÃ¡lidos al crear pelÃ­cula
TOKEN=$(curl -s -c err_cookies.txt http://localhost:5247/Peliculas/Create | grep -oP '__RequestVerificationToken.*?value="\K[^"]+')

curl -X POST http://localhost:5247/Peliculas/Create \
  -b err_cookies.txt \
  -d "__RequestVerificationToken=$TOKEN" \
  -d "Titulo=Test" \
  -d "FechaLanzamiento=FECHA_INVALIDA" \
  -d "Duracion=NO_ES_NUMERO" \
  -i
```

**Buscar en la respuesta:**

- âŒ Stack traces
- âŒ Nombres de tablas o columnas SQL
- âŒ Rutas del filesystem
- âœ… Mensaje genÃ©rico: "Invalid data format"

---

## âœ… Prueba 4: Verificar cookies y sesiones

### ğŸ“¡ Inspeccionar cookies del sitio

```bash
curl -i -c cookies.txt http://localhost:5247/Peliculas
cat cookies.txt
```

**Ejemplo de cookies:**

```
# Netscape HTTP Cookie File
.localhost	TRUE	/	FALSE	0	.AspNetCore.Antiforgery.abc123	CfDJ8...
.localhost	TRUE	/	FALSE	0	.AspNetCore.Session	abc123...
```

**AnÃ¡lisis de flags de seguridad:**

```bash
# Ver cookies con detalles
curl -I -c - http://localhost:5247/Peliculas | grep -i "set-cookie"
```

**Cookies seguras deben tener:**

- âœ… `HttpOnly` â†’ Previene acceso desde JavaScript (XSS)
- âœ… `Secure` â†’ Solo se envÃ­a por HTTPS
- âœ… `SameSite=Strict` â†’ Previene CSRF

**Ejemplo seguro:**

```
Set-Cookie: .AspNetCore.Session=abc123; path=/; HttpOnly; Secure; SameSite=Strict
```

**Ejemplo INSEGURO:**

```
Set-Cookie: .AspNetCore.Session=abc123; path=/
```

---

## âœ… Prueba 5: BÃºsqueda de archivos sensibles expuestos

### ğŸ“¡ Intentar acceder a archivos de configuraciÃ³n

```bash
# appsettings.json (NO debe ser pÃºblico)
curl -i http://localhost:5247/appsettings.json

# appsettings.Development.json
curl -i http://localhost:5247/appsettings.Development.json

# web.config (IIS)
curl -i http://localhost:5247/web.config

# .env (variables de entorno)
curl -i http://localhost:5247/.env

# Backup de BD
curl -i http://localhost:5247/backup.sql
```

**Respuesta esperada:**

```
HTTP/1.1 404 Not Found
```

**AnÃ¡lisis:**

- âŒ **VULNERABLE**: Si devuelve 200 y el contenido del archivo (expone connection strings, secrets)
- âœ… **SEGURO**: Si devuelve 404 (archivos no accesibles pÃºblicamente)

---

### ğŸ“¡ Path Traversal para acceder a archivos del sistema

```bash
# Intentar leer archivos fuera del webroot
curl -i "http://localhost:5247/../../../../etc/passwd"
curl -i "http://localhost:5247/..\..\..\..\Windows\System32\drivers\etc\hosts"

# Con encoding
curl -i "http://localhost:5247/%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd"
```

**Respuesta esperada:**

```
HTTP/1.1 400 Bad Request
```

**AnÃ¡lisis:**

- âŒ **VULNERABLE**: Si devuelve el contenido de archivos del sistema
- âœ… **SEGURO**: Si rechaza la peticiÃ³n (ASP.NET Core valida rutas por defecto)

---

## âœ… Prueba 6: Ataque de fuerza bruta (Rate Limiting)

### ğŸ“¡ Enviar mÃºltiples requests rÃ¡pidos

```bash
# Script para enviar 100 requests en poco tiempo
for i in {1..100}; do
  curl -s -o /dev/null -w "Request $i: %{http_code} - %{time_total}s\n" http://localhost:5247/Peliculas &
done
wait
```

**Â¿QuÃ© buscar?**

- âŒ **Sin protecciÃ³n**: Todos los requests devuelven 200
- âœ… **Con Rate Limiting**: DespuÃ©s de N requests, empieza a devolver 429 (Too Many Requests)

**AnÃ¡lisis:**

- âŒ Sin rate limiting â†’ Vulnerable a:
  - Fuerza bruta de contraseÃ±as
  - DoS (Denial of Service)
  - Scraping masivo
- âœ… Con rate limiting â†’ Mejor protecciÃ³n

---

## ğŸ“Š Resumen A2 - Cryptographic Failures

| Prueba                  | Comando                     | Resultado              | Severidad  |
| ----------------------- | --------------------------- | ---------------------- | ---------- |
| Uso de HTTPS            | `curl -I http://...`        | âš ï¸ HTTP en dev         | ğŸ”´ En prod |
| Headers de seguridad    | `curl -I \| grep...`        | âŒ No configurados     | ğŸŸ¡ Media   |
| Datos sensibles en HTML | `curl \| grep password`     | âœ… No encontrados      | ğŸŸ¢ N/A     |
| Stack traces en errores | `curl .../99999`            | âš ï¸ Depende de env      | ğŸŸ¡/ğŸ”´      |
| Cookies seguras         | `curl -I \| grep cookie`    | âš ï¸ Sin Secure/HttpOnly | ğŸŸ¡ Media   |
| Archivos sensibles      | `curl .../appsettings.json` | âœ… 404 (protegido)     | ğŸŸ¢ N/A     |
| Rate limiting           | Loop con curl               | âŒ Sin protecciÃ³n      | ğŸŸ¡ Media   |

**ConclusiÃ³n:** La app tiene **EXPOSICIÃ“N MEDIA** - No hay datos sensibles expuestos, pero faltan headers de seguridad y rate limiting.

---

## ğŸ› ï¸ Soluciones Recomendadas

### Forzar HTTPS en producciÃ³n

```csharp
// En Program.cs
if (!app.Environment.IsDevelopment())
{
    app.UseHttpsRedirection();
    app.UseHsts();
}
```

### Agregar headers de seguridad

```csharp
// En Program.cs
app.Use(async (context, next) =>
{
    context.Response.Headers.Add("X-Content-Type-Options", "nosniff");
    context.Response.Headers.Add("X-Frame-Options", "DENY");
    context.Response.Headers.Add("X-XSS-Protection", "1; mode=block");
    context.Response.Headers.Add("Referrer-Policy", "no-referrer");
    await next();
});
```

### Configurar cookies seguras

```csharp
// En Program.cs
builder.Services.AddAntiforgery(options =>
{
    options.Cookie.SecurePolicy = CookieSecurePolicy.Always;
    options.Cookie.HttpOnly = true;
    options.Cookie.SameSite = SameSiteMode.Strict;
});
```

### Ocultar errores en producciÃ³n

```csharp
// En Program.cs
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
}
else
{
    app.UseExceptionHandler("/Home/Error");
    // No mostrar stack traces
}
```

---

## ğŸ“¸ Capturas para el Informe

1. Screenshot de `curl -I http://localhost:5247` mostrando ausencia de headers de seguridad
2. Screenshot de error 404 con/sin stack trace
3. Screenshot de cookies sin flags HttpOnly/Secure
4. Screenshot del cÃ³digo con headers de seguridad implementados
